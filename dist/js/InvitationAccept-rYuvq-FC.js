import{d as S,s as r,j as e}from"./index-CshFh5IW.js";import{f as k,e as D,r as n}from"./react-vendor-DS3Z5Hf_.js";import{X as q,g,B as E,c as I,j as C,J as R}from"./ui-vendor-DnkZPEX2.js";import"./supabase-vendor-CCigGT7m.js";import"./utils-vendor-BJeS7sC5.js";const F=()=>{const[h]=k(),{user:l}=S(),d=D(),[s,f]=n.useState(null),[p,x]=n.useState(!0),[o,c]=n.useState(!1),[u,a]=n.useState(null),m=h.get("token");n.useEffect(()=>{m?j():(a("유효하지 않은 초대 링크입니다."),x(!1))},[m]);const j=async()=>{try{const{data:t,error:i}=await r.from("team_invitations").select(`
          id,
          email,
          role,
          status,
          expires_at,
          tenant_id,
          inviter_id
        `).eq("invitation_token",m).eq("status","pending").single();if(i||!t){a("초대를 찾을 수 없거나 이미 처리된 초대입니다.");return}if(new Date(t.expires_at)<new Date){a("만료된 초대입니다.");return}if(l?.email!==t.email){a("초대받은 이메일과 로그인한 계정이 다릅니다.");return}const[N,w]=await Promise.all([r.from("tenants").select("name").eq("id",t.tenant_id).single(),r.from("user_profiles").select("name").eq("id",t.inviter_id).single()]),_={...t,tenant:{name:N.data?.name||"알 수 없는 팀"},inviter:{name:w.data?.name||"알 수 없는 사용자"}};f(_)}catch{a("초대 정보를 불러오는데 실패했습니다.")}finally{x(!1)}},b=async()=>{if(!(!s||!l))try{c(!0);const{error:t}=await r.from("team_invitations").update({status:"accepted",updated_at:new Date().toISOString()}).eq("id",s.id);if(t)throw t;const{error:i}=await r.from("user_profiles").update({tenant_id:s.tenant_id,role:s.role,joined_at:new Date().toISOString(),status:"active"}).eq("id",l.id);if(i)throw i;await r.from("team_activity_logs").insert({tenant_id:s.tenant_id,user_id:l.id,action:"invitation_accepted",details:{invitation_id:s.id,role:s.role}}),alert("팀 초대를 수락했습니다! 잠시 후 대시보드로 이동합니다."),setTimeout(()=>{d("/")},1e3)}catch(t){a(t.message||"초대 수락에 실패했습니다.")}finally{c(!1)}},y=async()=>{if(s&&confirm("정말로 초대를 거절하시겠습니까?"))try{c(!0);const{error:t}=await r.from("team_invitations").update({status:"declined",updated_at:new Date().toISOString()}).eq("id",s.id);if(t)throw t;alert("초대를 거절했습니다."),d("/")}catch(t){a(t.message||"초대 거절에 실패했습니다.")}finally{c(!1)}},v=t=>({owner:"팀 소유자",admin:"관리자",member:"멤버",viewer:"뷰어"})[t]||t;return p?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"초대 정보를 확인하는 중..."})]})}):u?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsx("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(q,{className:"w-8 h-8 text-red-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"오류가 발생했습니다"}),e.jsx("p",{className:"text-gray-600 mb-6",children:u}),e.jsx("button",{onClick:()=>d("/"),className:"bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:"대시보드로 이동"})]})})}):s?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(g,{className:"w-8 h-8 text-blue-600"})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"팀 초대"}),e.jsx("p",{className:"text-gray-600",children:"팀에 합류하도록 초대되었습니다"})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx(E,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"팀"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.tenant?.name||"알 수 없는 팀"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx(I,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"초대자"}),e.jsx("p",{className:"font-medium text-gray-900",children:s.inviter?.name||"알 수 없는 사용자"})]})]}),e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx(g,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"역할"}),e.jsx("p",{className:"font-medium text-gray-900",children:v(s.role)})]})]}),e.jsxs("div",{className:"flex items-center space-x-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx(C,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"만료일"}),e.jsx("p",{className:"font-medium text-gray-900",children:new Date(s.expires_at).toLocaleDateString("ko-KR")})]})]})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:y,disabled:o,className:"flex-1 bg-gray-100 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium",children:"거절"}),e.jsx("button",{onClick:b,disabled:o,className:"flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium flex items-center justify-center space-x-2",children:o?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-5 h-5"}),e.jsx("span",{children:"수락"})]})})]}),e.jsx("p",{className:"text-xs text-gray-500 text-center mt-4",children:"초대를 수락하면 현재 팀에서 나가고 새로운 팀으로 이동됩니다."})]})}):null};export{F as InvitationAccept};
