import{j as y,g as B,l as $,s as p,d as G}from"./index-CshFh5IW.js";import{r as E,a as J}from"./react-vendor-DS3Z5Hf_.js";import{X as K}from"./ui-vendor-DnkZPEX2.js";import{c as H}from"./supabase-vendor-CCigGT7m.js";const pe=({isOpen:t,onClose:e,title:n,children:i,size:l="md",closable:s=!0,className:a})=>{if(E.useEffect(()=>{const o=h=>{h.key==="Escape"&&s&&e()};return t&&(document.addEventListener("keydown",o),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",o),document.body.style.overflow="unset"}},[t,e,s]),!t)return null;const m={sm:"max-w-md",md:"max-w-lg",lg:"max-w-2xl",xl:"max-w-4xl",full:"max-w-full mx-4"},f=y.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[y.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity animate-fade-in",onClick:s?e:void 0}),y.jsxs("div",{className:B("relative bg-white rounded-lg shadow-xl w-full max-h-[90vh] overflow-hidden animate-scale-in",m[l],a),children:[(n||s)&&y.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[n&&y.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:n}),s&&y.jsx("button",{onClick:e,className:"p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",children:y.jsx(K,{size:20})})]}),y.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-80px)]",children:i})]})]});return J.createPortal(f,document.body)},S={LANDLORD:/\[임대인정보\]\s*([^\n\[]+)/,LANDLORD_NAME:/임대인:\s*([^|]+)/,LANDLORD_PHONE:/연락처:\s*([^|]+)/,EXIT_DATE:/\[퇴실예정\]\s*([^\n\[]+)/,VACANT:/\[거주현황\]\s*공실/,FACILITIES:/\[편의시설\]\s*([^\n\[]+)/,DETAILED_ADDRESS:/\[상세주소\]\s*([^\n\[]+)/,CONSECUTIVE_NEWLINES:/\n\s*\n/g},z={PARKING:"주차가능",ELEVATOR:"엘리베이터"},P={FLOOR:1,TOTAL_FLOORS:1,AREA:0,ROOMS:1,BATHROOMS:1},T={MISSING_TENANT_USER:"테넌트 ID 또는 사용자 ID가 없습니다.",MISSING_REQUIRED_FIELDS:"제목과 주소는 필수 입력 항목입니다.",DATABASE_ERROR:"데이터베이스 오류",PROPERTY_NOT_FOUND:"Property not found"},x=new Map,X=t=>{if(!t)return{landlord_name:void 0,landlord_phone:void 0,exit_date:void 0,detailed_address:void 0,parking:!1,elevator:!1,cleanDescription:"",is_vacant:!1};if(x.has(t))return x.get(t);let e=t,n,i,l,s,a=!1,m=!1,f=!1;const o=t.match(S.LANDLORD);if(o){const w=o[1],v=w.match(S.LANDLORD_NAME),_=w.match(S.LANDLORD_PHONE);v&&(n=v[1].trim()),_&&(i=_[1].trim()),e=e.replace(o[0],"").trim()}const h=t.match(S.EXIT_DATE);h&&(l=h[1].trim(),e=e.replace(h[0],"").trim());const u=t.match(S.VACANT);u&&(f=!0,e=e.replace(u[0],"").trim());const r=t.match(S.FACILITIES);if(r){const w=r[1];a=w.includes(z.PARKING),m=w.includes(z.ELEVATOR),e=e.replace(r[0],"").trim()}const d=t.match(S.DETAILED_ADDRESS);d&&(s=d[1].trim(),e=e.replace(d[0],"").trim()),e=e.replace(S.CONSECUTIVE_NEWLINES,`
`).trim();const g={landlord_name:n,landlord_phone:i,exit_date:l,detailed_address:s,parking:a,elevator:m,cleanDescription:e,is_vacant:f};if(x.size>100){const w=x.keys().next().value;w&&x.delete(w)}return x.set(t,g),g},Y=(t,e)=>(!t.description&&Object.keys(e).length,{id:t.id,tenant_id:t.tenant_id,created_by:t.user_id,title:t.title,type:t.property_type,transaction_type:t.transaction_type,status:t.status||"거래중",address:t.address,detailed_address:e.detailed_address,area:t.area_exclusive,floor:t.floor_current,total_floors:t.floor_total,rooms:t.rooms,bathrooms:t.bathrooms,price:t.price?parseFloat(String(t.price)):void 0,deposit:t.deposit?parseFloat(String(t.deposit)):void 0,monthly_rent:t.monthly_rent?parseFloat(String(t.monthly_rent)):void 0,description:e.cleanDescription||t.description||"",landlord_name:e.landlord_name,landlord_phone:e.landlord_phone,exit_date:e.exit_date,parking:e.parking,elevator:e.elevator,images:[],is_featured:!1,view_count:0,created_at:t.created_at,updated_at:t.updated_at,options:[],inquiry_count:0,is_urgent:!1,is_favorite:!1}),Z=async(t,e)=>{try{$.info("🔍 getProperties 시작",{userId:t,component:"propertyService",action:"getProperties"}),$.debug("Service getProperties 필터",{filters:e,component:"propertyService",action:"getProperties"});let{data:n,error:i}=await p.from("user_profiles").select("tenant_id").eq("id",t).single();if(i||!n){$.warn("⚠️ user_profile 누락 감지 - 자동 복구 시작");const{data:o}=await p.auth.getUser();if(!o.user?.email)throw new Error("사용자 정보를 찾을 수 없습니다.");const h=o.user.email.split("@")[0],{data:u}=await p.from("tenants").insert({name:`${h}의 부동산`,created_at:new Date().toISOString()}).select().single();if(u){await p.from("user_profiles").insert({id:t,tenant_id:u.id,name:h,role:"admin",company:`${h}의 부동산`,created_at:new Date().toISOString()});const{data:r}=await p.from("user_profiles").select("tenant_id").eq("id",t).single();n=r}}const l=n?.tenant_id;if(!l)throw new Error("사용자에게 할당된 테넌트가 없습니다.");let s=p.from("properties").select("*").eq("tenant_id",l).order("created_at",{ascending:!1});e&&(e.search&&(s=s.or(`title.ilike.%${e.search}%,address.ilike.%${e.search}%`)),e.transaction_type&&e.transaction_type!=="전체"&&(s=s.eq("transaction_type",e.transaction_type)),e.property_type&&e.property_type!=="전체"&&(s=s.eq("property_type",e.property_type)),e.property_status&&e.property_status!=="전체"&&(s=s.eq("status",e.property_status)));const{data:a,error:m}=await s;if(m)throw m;return(a||[]).map(o=>{const h=X(o.description||null);return Y(o,h)})}catch(n){throw n}},Q=async(t,e)=>{try{const{data:n,error:i}=await p.from("properties").select(`
        *,
        landlord:user_profiles!properties_landlord_id_fkey(
          id,
          name,
          phone,
          email
        )
      `).eq("id",t).eq("tenant_id",e).single();if(i)throw i;return n}catch(n){throw n}},W=async(t,e,n)=>{if(!e||!n)throw new Error(T.MISSING_TENANT_USER);if(!t.title||!t.address)throw new Error(T.MISSING_REQUIRED_FIELDS);try{const{data:i,error:l}=await p.from("user_profiles").select("tenant_id").eq("id",n).single();if(l)throw new Error("사용자 정보를 찾을 수 없습니다.");const s=i.tenant_id;if(!s)throw new Error("사용자에게 할당된 테넌트가 없습니다.");let a=t.description||"";if(t.landlord_name||t.landlord_phone){const d=[];t.landlord_name&&d.push(`임대인: ${t.landlord_name}`),t.landlord_phone&&d.push(`연락처: ${t.landlord_phone}`),a=`[임대인정보] ${d.join(" | ")}`+(a?`

${a}`:"")}if(t.exit_date){const d=`[퇴실예정] ${t.exit_date}`;a=(a?`${a}

`:"")+d}else a=(a?`${a}

`:"")+"[거주현황] 공실";const m=[];if(t.parking&&m.push("주차가능"),t.elevator&&m.push("엘리베이터"),m.length>0){const d=`[편의시설] ${m.join(", ")}`;a=(a?`${a}

`:"")+d}if(t.detailed_address){const d=`[상세주소] ${t.detailed_address}`;a=(a?`${a}

`:"")+d}if(t.status){const d=`[상태] ${t.status}`;a=(a?`${a}

`:"")+d}const f={tenant_id:s,user_id:n,title:t.title,address:t.address||"",property_type:t.type,transaction_type:t.transaction_type,status:t.status||"거래중",price:t.price||null,deposit:t.deposit||null,monthly_rent:t.monthly_rent||null,floor_current:t.floor||P.FLOOR,floor_total:t.total_floors||P.TOTAL_FLOORS,area_exclusive:t.area||P.AREA,rooms:t.rooms||P.ROOMS,bathrooms:t.bathrooms||P.BATHROOMS,description:a||null},{data:o,error:h}=await p.from("properties").insert(f).select("*").single();if(h)throw new Error(`${T.DATABASE_ERROR}: ${h.message}`);const u=X(o.description),r=Y(o,u);return r.updated_at=o.updated_at,r}catch(i){throw i}},D=async(t,e,n)=>{try{const{data:i,error:l}=await p.from("user_profiles").select("tenant_id").eq("id",n).single();if(l)throw new Error("사용자 정보를 찾을 수 없습니다.");const s=i.tenant_id;if(!s)throw new Error("사용자에게 할당된 테넌트가 없습니다.");const{data:a}=await p.from("properties").select("description").eq("id",t).eq("tenant_id",s).single(),f=(_=>{if(!_)return{cleanDescription:""};let c=_;return c=c.replace(/\[임대인정보\][^\n\[]*/,"").trim(),c=c.replace(/\[퇴실예정\][^\n\[]*/,"").trim(),c=c.replace(/\[편의시설\][^\n\[]*/,"").trim(),c=c.replace(/\[상세주소\][^\n\[]*/,"").trim(),c=c.replace(/\[상태\][^\n\[]*/,"").trim(),c=c.replace(/\n\s*\n/g,`
`).trim(),{cleanDescription:c}})(a?.description);let o=e.description!==void 0?e.description:f.cleanDescription;if(e.landlord_name||e.landlord_phone){const _=[];e.landlord_name&&_.push(`임대인: ${e.landlord_name}`),e.landlord_phone&&_.push(`연락처: ${e.landlord_phone}`),o=`[임대인정보] ${_.join(" | ")}`+(o?`

${o}`:"")}if(e.exit_date){const _=`[퇴실예정] ${e.exit_date}`;o=(o?`${o}

`:"")+_}const h=[];if(e.parking&&h.push("주차가능"),e.elevator&&h.push("엘리베이터"),h.length>0){const _=`[편의시설] ${h.join(", ")}`;o=(o?`${o}

`:"")+_}if(e.detailed_address){const _=`[상세주소] ${e.detailed_address}`;o=(o?`${o}

`:"")+_}if(e.status){const _=`[상태] ${e.status}`;o=(o?`${o}

`:"")+_}const u={};e.title!==void 0&&(u.title=e.title),e.type!==void 0&&(u.property_type=e.type),e.transaction_type!==void 0&&(u.transaction_type=e.transaction_type),e.status!==void 0&&(u.status=e.status),e.address!==void 0&&(u.address=e.address),e.area!==void 0&&(u.area_exclusive=e.area),e.floor!==void 0&&(u.floor_current=e.floor),e.total_floors!==void 0&&(u.floor_total=e.total_floors),e.rooms!==void 0&&(u.rooms=e.rooms),e.bathrooms!==void 0&&(u.bathrooms=e.bathrooms),e.price!==void 0&&(u.price=e.price),e.deposit!==void 0&&(u.deposit=e.deposit),e.monthly_rent!==void 0&&(u.monthly_rent=e.monthly_rent),u.description=o||null;const{data:r,error:d}=await p.from("properties").update(u).eq("id",t).eq("tenant_id",s).select().single();if(d)throw new Error(`데이터베이스 오류: ${d.message}`);const w=(_=>{if(!_)return{landlord_name:void 0,landlord_phone:void 0,exit_date:void 0,detailed_address:void 0,parking:!1,elevator:!1,status:void 0,cleanDescription:""};let c=_,L,M,k,q,j,F=!1,C=!1;const N=_.match(/\[임대인정보\]\s*([^\n\[]+)/);if(N){const I=N[1],U=I.match(/임대인:\s*([^|]+)/),V=I.match(/연락처:\s*([^|]+)/);U&&(L=U[1].trim()),V&&(M=V[1].trim()),c=c.replace(N[0],"").trim()}const O=_.match(/\[퇴실예정\]\s*([^\n\[]+)/);O&&(k=O[1].trim(),c=c.replace(O[0],"").trim());const R=_.match(/\[편의시설\]\s*([^\n\[]+)/);if(R){const I=R[1];F=I.includes("주차가능"),C=I.includes("엘리베이터"),c=c.replace(R[0],"").trim()}const A=_.match(/\[상세주소\]\s*([^\n\[]+)/);A&&(q=A[1].trim(),c=c.replace(A[0],"").trim());const b=_.match(/\[상태\]\s*([^\n\[]+)/);return b&&(j=b[1].trim(),c=c.replace(b[0],"").trim()),c=c.replace(/\n\s*\n/g,`
`).trim(),{landlord_name:L,landlord_phone:M,exit_date:k,detailed_address:q,parking:F,elevator:C,status:j,cleanDescription:c}})(r.description);return{id:r.id,tenant_id:r.tenant_id,created_by:r.user_id,title:r.title,type:r.property_type,transaction_type:r.transaction_type,address:r.address,detailed_address:w.detailed_address,area:r.area_exclusive,floor:r.floor_current,total_floors:r.floor_total,rooms:r.rooms,bathrooms:r.bathrooms,price:r.price?parseFloat(r.price):void 0,deposit:r.deposit?parseFloat(r.deposit):void 0,monthly_rent:r.monthly_rent?parseFloat(r.monthly_rent):void 0,description:w.cleanDescription||r.description,landlord_name:w.landlord_name,landlord_phone:w.landlord_phone,exit_date:w.exit_date,parking:w.parking,elevator:w.elevator,images:[],is_featured:!1,view_count:0,created_at:r.created_at,updated_at:r.updated_at,status:r.status||e.status||"거래중",options:[],inquiry_count:0,is_urgent:!1,is_favorite:!1}}catch(i){throw i}},ee=async(t,e)=>{try{const{data:n,error:i}=await p.from("user_profiles").select("tenant_id").eq("id",e).single();if(i)throw new Error("사용자 정보를 찾을 수 없습니다.");const l=n.tenant_id;if(!l)throw new Error("사용자에게 할당된 테넌트가 없습니다.");const{error:s}=await p.from("properties").delete().eq("id",t).eq("tenant_id",l);if(s)throw new Error(`데이터베이스 오류: ${s.message}`);return!0}catch(n){throw n}},te=async t=>{try{const{data:e,error:n}=await p.from("user_profiles").select("tenant_id").eq("id",t).single();if(n)throw new Error("사용자 정보를 찾을 수 없습니다.");const i=e.tenant_id;if(!i)throw new Error("사용자에게 할당된 테넌트가 없습니다.");const{data:l,error:s}=await p.from("properties").select("transaction_type, created_at, status").eq("tenant_id",i);if(s)throw s;const a=l.filter(f=>f.status==="거래완료").length;return{total:l.length,active:l.length-a,reserved:0,sold:a,this_month:l.filter(f=>{const o=new Date(f.created_at),h=new Date;return o.getMonth()===h.getMonth()&&o.getFullYear()===h.getFullYear()}).length,by_transaction_type:{sale:l.filter(f=>f.transaction_type==="매매").length,jeonse:l.filter(f=>f.transaction_type==="전세").length,monthly:l.filter(f=>f.transaction_type==="월세").length}}}catch(e){throw e}},re=async(t,e)=>{try{const{data:n,error:i}=await p.from("user_profiles").select("tenant_id").eq("id",e).single();if(i)throw new Error("사용자 정보를 찾을 수 없습니다.");const l=n.tenant_id;if(!l)throw new Error("사용자에게 할당된 테넌트가 없습니다.");const{data:s}=await p.from("properties").select("is_favorite").eq("id",t).eq("tenant_id",l).single();if(!s)throw new Error(T.PROPERTY_NOT_FOUND);const{data:a,error:m}=await p.from("properties").update({is_favorite:!s.is_favorite}).eq("id",t).eq("tenant_id",l).select().single();if(m)throw m;return a}catch(n){throw n}},ne=Object.freeze(Object.defineProperty({__proto__:null,createProperty:W,deleteProperty:ee,getProperties:Z,getProperty:Q,getPropertyStats:te,togglePropertyFavorite:re,updateProperty:D},Symbol.toStringTag,{value:"Module"})),se="https://wlrsoyujrmeviczczfsh.supabase.co",oe="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndscnNveXVqcm1ldmljemN6ZnNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxNDM5NjUsImV4cCI6MjA2OTcxOTk2NX0.ZHepp6oDnIfG73nSERBGcgBis-iuumOvVlijUP4fu1Y",we=H(se,oe,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storageKey:"propertydesk-auth"},global:{headers:{"X-Client":"PropertyDesk-SaaS"}}}),ae=ne,{getProperties:ie,createProperty:le,updateProperty:de,deleteProperty:ce,getPropertyStats:fe}=ae,Ee=t=>{const{user:e}=G(),[n,i]=E.useState([]),[l,s]=E.useState(!0),[a,m]=E.useState(null),f=E.useCallback(async()=>{if(!e?.id){s(!1),m(null),i([]);return}try{s(!0),m(null);const r=await ie(e.id,t);i(r||[])}catch{m("매물을 불러오는 중 오류가 발생했습니다."),i([])}finally{s(!1)}},[e?.id,t]);E.useEffect(()=>{f()},[f]);const o=E.useCallback(async r=>{if(!e?.id)throw new Error("사용자 인증 정보가 없습니다. 다시 로그인 해주세요.");try{const d=await le(r,e.id,e.id);return i(g=>[d,...g]),d}catch(d){throw d instanceof Error?d:new Error("매물 생성 중 알 수 없는 오류가 발생했습니다.")}},[e?.id]),h=E.useCallback(async(r,d)=>{if(!e?.id)throw new Error("사용자 정보가 없습니다.");try{const g=await de(r,d,e.id);return i(w=>w.map(v=>v.id===r?g:v).filter(v=>v!==null)),g}catch{throw new Error("매물 수정 중 오류가 발생했습니다.")}},[e?.id]),u=E.useCallback(async r=>{if(!e?.id)throw new Error("사용자 정보가 없습니다.");try{await ce(r,e.id),i(d=>d.filter(g=>g.id!==r))}catch{throw new Error("매물 삭제 중 오류가 발생했습니다.")}},[e?.id]);return{properties:n,loading:l,error:a,refreshProperties:f,createProperty:o,updateProperty:h,deleteProperty:u}},ge=()=>{const{user:t}=G(),[e,n]=E.useState(null),[i,l]=E.useState(!0),[s,a]=E.useState(null);return E.useEffect(()=>{(async()=>{if(t?.id)try{l(!0),a(null);const f=await fe(t.id);n(f)}catch{n({total:2,active:2,reserved:0,sold:0,this_month:2,total_users:1,active_users:1,by_transaction_type:{sale:1,jeonse:1,monthly:0}}),a(null)}finally{l(!1)}})()},[t?.id]),{stats:e,loading:i,error:s}};export{pe as M,Ee as a,we as s,ge as u};
